{% extends 'web/base.html' %}
{% load i18n %}
{% load static %}
{% block content %}
<div class="col-md-9">
	<div class="wall">
		<h2 class="title">Тэмцээн</h2>
    <div class="buttons">
      <button class="btn-sm btn-success">{% trans 'Бүртгэл эхэлсэн тэмцээн' %}</button>
      <button class="btn-sm btn-info">{% trans 'Эхэлсэн тэмцээн' %}</button>
      <button class="btn-sm btn-primary">{% trans 'Дууссан тэмцээн' %}</button>
      <button class="btn-sm btn-danger" date="daterange"><i class="fa fa-calendar"></i></button>
    </div>
    <ul class="nav nav-tabs text-sm">
      <li class="active"><a href="#table-competition" data-toggle="tab">Хүснэгт</a></li>
      <li><a href="#calendar-competition" data-toggle="tab">Календарь</a></li>
    </ul>
    <div class="tab-content text-sm">
      <div class="tab-pane active" id="table-competition">
        <table class="table table-bordered table-hover table-striped">
          <thead>
            <tr>
              <th>{% trans '№' %}</th>
              <th>{% trans 'Ангилал' %}</th>
              <th>{% trans 'Эхлэх огноо' %}</th>
              <th>{% trans 'Дуусах огноо' %}</th>
              <th>{% trans 'Төлөв' %}</th>
              <th>{% trans 'Шагналын сан' %}</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for o in object_list %}
            {% if o.started %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td>{{ o.last_ranked.name }}</td>
              <td>{{ o.historys.start|date:"Y-m-d H:i:s" }}</td>
              <td>{{ o.historys.end|date:"Y-m-d H:i:s" }}</td>
              <td>
                <span class='label label-pill label-{% if o.competition_status == "0" %}success{% elif o.competition_status == "1" %}info{% else %}primary{% endif %}'>
                  {{ o.historys.get_competition_status_display }}
                </span>
              </td>
              <td>{{ o.last_ranked.shagnal }}</td>
              <td>
                {% if o.if_registered %}
                <span class="label label-pill label-warning">{% trans 'Бүртгэлтэй байна' %}</span>
                {% endif %}
              </td>
            </tr>
            {% else %}
            <tr>
              <td>
                {{ forloop.counter }} 
              </td>
              <td>{{ o.rank.name }}</td>
              <td>{{ o.start|date:"Y-m-d H:i:s" }}</td>
              <td>{{ o.end|date:"Y-m-d H:i:s" }}</td>
              <td>
                <span class='label label-pill label-{% if o.competition_status == "0" %}success{% elif o.competition_status == "1" %}info{% else %}primary{% endif %}'>
                  {{ o.historys.get_competition_status_display }}
                </span>
              </td>
              <td>{{ o.rank.shagnal }}</td>
              <td>
                {% if o.if_registered %}
                <span class="label label-pill label-warning">{% trans 'Бүртгэлтэй байна' %}</span>
                {% else %}
                {% if user.is_authenticated %}
                  <a href="{% url 'web_competition_register' o.id %}" data-modal="modalview" class="btn btn-success btn-flat btn-xs">
                    {% trans 'Бүртгүүлэх' %}
                  </a>
                  {% else %}
                  <a href="{% url 'login' %}" class="btn btn-success btn-flat btn-xs">
                    {% trans 'Бүртгүүлэх' %}
                  </a>
                  {% endif %}
                {% endif %}
              </td>
            </tr>
            {% endif %}
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="tab-pane text-sm" id="calendar-competition">
        <div id="calendar" class="calendar" style="height: 1000px;"></div>
      </div>
    </div>
	</div>
</div>
{% comment %}
{% for o in object_list %}
<div class="modal fade" id="shagnal{{ o.id }}">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">Шагналын сан</h4>
      </div>
      <div class="modal-body">
        {{ o.rank.shagnal|safe }}
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default btn-flat" data-dismiss="modal">Хаах</button>
      </div>
    </div>
  </div>
</div>
{% endfor %}
{% endcomment %}
{% endblock %}
{% block extrajs %}
<script src="{% static 'assets/assets/bootstrap-year-calendar-master/js/bootstrap-year-calendar.js' %}"></script>

<script type="text/javascript">
  $(function() {
      var currentYear = new Date().getFullYear();
      
      $('#calendar').calendar({ 
        enableContextMenu: true,
        enableRangeSelection: true,

        mouseOnDay: function(e) {
          if(e.events.length > 0) {
            var content = '';
                  
            for(var i in e.events) {
              content += '<div class="event-tooltip-content">'
              + '<div class="event-name" style="color:' + e.events[i].color + '">' + e.events[i].name + '</div>'
              + '<div class="event-location">' + e.events[i].location + '</div>'
              + '</div>';
            }
              
            $(e.element).popover({ 
              trigger: 'manual',
              container: 'body',
              html:true,
              content: content
            });
            
            $(e.element).popover('show');
            }
          },
          mouseOutDay: function(e) {
            if(e.events.length > 0) {
              $(e.element).popover('hide');
            }
          },
          dayContextMenu: function(e) {
            $(e.element).popover('hide');
          },
          //clickDay: function(e) {
          //  if(e.events.length > 0){
          //    for(var i in e.events) {
          //      window.location.href  = "/competition/register/"+e.events[i].id;  
          //    }  
          //  }
          //},
          dataSource: [
            {% for o in object_list %}
              {
                id: {{ o.id }},
                name: '{{ o.rank.name }}',
                location: '{{ o.get_competition_status_display }}',
                startDate: new Date({{ o.start.year }}, {{ o.start.month }} - 1, {{ o.start.day }}),
                endDate: new Date({{ o.end.year }}, {{ o.end.month }} - 1, {{ o.end.day }}),
                {% if o.competition_status == '0' %}
                color:'#5cb85c'
                {% else %}
                color:'#337ab7'
                {% endif %}
              },
            {% endfor %}
          ]
      });
  });

  $(function(){
    $('button[date="daterange"]').daterangepicker();
  });

  /* Last tab show */
  $('a[data-toggle="tab"]').click(function (e) {
    e.preventDefault();
    $(this).tab('show');
  });

  $('a[data-toggle="tab"]').on("shown.bs.tab", function (e) {
      var id = $(e.target).attr("href");
      localStorage.setItem('selectedTab', id)
  });

  var selectedTab = localStorage.getItem('selectedTab');
  if (selectedTab != null) {
      $('a[data-toggle="tab"][href="' + selectedTab + '"]').tab('show');
  }
</script>
{% endblock %}